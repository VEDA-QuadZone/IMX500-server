# IMX500-server

λ³Έ ν”„λ΅μ νΈλ” **VEDA-QuadZone**μ΄λΌλ” μ΄λ¦„μ λΌμ¦λ² λ¦¬νμ΄ κΈ°λ° CCTV AI μ‹μ¤ν…μΌλ΅,  
IMX500 AI μΉ΄λ©”λΌλ¥Ό μ΄μ©ν•΄ μ‹¤μ‹κ°„ κ°μ²΄ κ°μ§€, μ°¨λ‰ λ²νΈν μΈμ‹, μ†λ„ μΈ΅μ • λ“±μ λ‹¤μ–‘ν• μ΄λ²¤νΈλ¥Ό μ²λ¦¬ν•κ³ ,  
RTSPλ¥Ό ν†µν•΄ μ‹¤μ‹κ°„ μ¤νΈλ¦¬λ°κ³Ό μ΄λ²¤νΈ κΈ°λ° μ•λ¦Όμ„ μ κ³µν•λ” κ²ƒμ΄ λ©μ μ…λ‹λ‹¤.

μ΄ λ ν¬μ§€ν† λ¦¬μΈ **IMX500-server**λ” μ „μ²΄ μ‹μ¤ν…μ **μ„λ²„**λ΅μ„,  
IMX500 μΉ΄λ©”λΌλ΅λ¶€ν„° μμ‹ ν• μ¶”λ΅  κ²°κ³Όμ™€ ν”„λ μ„μ„ κΈ°λ°μΌλ΅ λ‹¤μ κΈ°λ¥μ„ μν–‰ν•©λ‹λ‹¤:

- μ°¨λ‰ λ° μ‚¬λμ— λ€ν• κ°μ§€ μ΄λ²¤νΈ ν›„μ²λ¦¬
- μ°¨λ‰ λ²νΈν μΈμ‹ (ONNX + TFLite)
- μ΄λ²¤νΈ κ°μ§€ λ° λ¶„λ¥ (λ¶λ²• μ£Όμ •μ°¨, κ³Όμ† λ“±)
- RTSPλ¥Ό ν†µν• μ‹¤μ‹κ°„ μμƒ μ†΅μ¶

μµμΆ…μ μΌλ΅ κ°μ§€ κ²°κ³Όλ” TCP μ„λ²„μ™€ Qt κΈ°λ° λ¨λ‹ν„°λ§ ν΄λΌμ΄μ–ΈνΈλ΅ μ „μ†΅λμ–΄ μ‹¤μ‹κ°„ ν™•μΈμ΄ κ°€λ¥ν•©λ‹λ‹¤.

---
## π“ ν”„λ΅μ νΈ μ „μ²΄ κµ¬μ„±λ„

- **μΉ΄λ©”λΌ μ„λ²„ (IMX500)**
  - κ°μ²΄ κ°μ§€ λ° ν”„λ μ„ μ¶”μ¶  
    (_.rpk μ¶”λ΅ , libcamera κΈ°λ°_)

- **[IMX500-server]** β† λ³Έ λ ν¬μ§€ν† λ¦¬
  - AI κ°μ§€ ν›„μ²λ¦¬
  - λ²νΈν μΈμ‹ (ONNX + TFLite)
  - μ΄λ²¤νΈ κ°μ§€ λ° μ²λ¦¬
  - μ‹¤μ‹κ°„ RTSP μ†΅μ¶

- **[raspi-cctv-tcp-server]**
  - μ°¨λ‰ μ†λ„ μ΄λ²¤νΈ μμ‹ 
  - TCP κΈ°λ° λ©”μ‹μ§€ μ²λ¦¬ μ„λ²„

- **[QuadQT]**
  - Qt κΈ°λ° λ¨λ‹ν„°λ§ ν΄λΌμ΄μ–ΈνΈ
  - RTSP μ¤νΈλ¦¬λ° μμƒ ν‘μ‹
  - μ΄λ²¤νΈ μμ‹  λ° UI μ•λ¦Ό
---

## π”© ν•λ“μ›¨μ–΄ μ¤ν™
| κµ¬λ¶„        | μ¥λΉ„/μ¬λ£                  | λ¨λΈλ…/μ‚¬μ–‘          | μ©λ„                           |
| --------- | ---------------------- | --------------- | ---------------------------- |
| λ©”μΈ μ»¨νΈλ΅¤λ¬   | Raspberry Pi 4 Model B | 4GB RAM         | μ „μ²΄ μ‹μ¤ν… μ μ–΄, RTSP μ¤νΈλ¦¬λ°, μ΄λ²¤νΈ μ²λ¦¬ |
| μ„λΈ μ»¨νΈλ΅¤λ¬   | STM32 Nucleo-F401RE    | Cortex-M4       | μ§€μκΈ° μ„Όμ„ μ‹ νΈ μ²λ¦¬, μ†λ„ κ³„μ‚°, UART ν†µμ‹  |
| μΉ΄λ©”λΌ       | IMX500 AI Camera       | 1280x720        | μ°¨λ‰ μΈμ‹, λ²νΈν μ΄¬μ                |
| LCD λ””μ¤ν”λ μ΄ | ST7789V SPI LCD        | 240x240 ν•΄μƒλ„     | μ΄λ²¤νΈ λ°μƒ μ‹ κ²½κ³  μ΄λ―Έμ§€ μ¶λ ¥           |
| μ¤λ””μ¤ DAC   | MAX98367A I2S DAC      | -               | λ””μ§€ν„Έ μ¤λ””μ¤ β†’ μ•„λ‚ λ΅κ·Έ λ³€ν™, κ²½κ³ μ μ¶λ ¥    |
| μ¤ν”Όμ»¤       | μ†ν• μ‚¬κ° μ¤ν”Όμ»¤              | 4Ξ©, 3W, 35x25mm | κ²½κ³ μ μ¬μƒ                       |
| μ§€μκΈ° μ„Όμ„    | DFRobot DFR0033        | λ””μ§€ν„Έ μ¶λ ¥          | μ°¨λ‰ ν†µκ³Ό κ°μ§€, μ†λ„ μΈ΅μ •              |
| λ¬΄μ„  ν†µμ‹  λ¨λ“  | HC-05 λΈ”λ£¨ν¬μ¤ λ¨λ“          | UART ν†µμ‹          | STM32 β†” Raspberry Pi λ°μ΄ν„° μ „μ†΅  |
| μ €μ¥μ¥μΉ      | MicroSD μΉ΄λ“             | 32GB            | OS λ° λ΅κ·Έ λ°μ΄ν„° μ €μ¥               |

---
## π› οΈ κΈ°μ  μ¤νƒ

| κµ¬λ¶„               | μ‚¬μ© ν™κ²½ / ν΄              | λ²„μ „                      | μ©λ„                                 |
|--------------------|-----------------------------|----------------------------|--------------------------------------|
| ν΄λΌμ΄μ–ΈνΈ κ°λ°    | Qt (Windows)                | 6.9.1                      | λ¨λ‹ν„°λ§ UI κ°λ°, RTSP μμƒ μ¬μƒ     |
| μμƒ μ²λ¦¬ λΌμ΄λΈλ¬λ¦¬ | OpenCV                      | 4.6.0                      | μ΄λ―Έμ§€ ν”„λ μ„ μ²λ¦¬ λ° ν…μ¤νΈ          |
| μμƒ μΈμ½”λ”©/λ””μ½”λ”© | FFmpeg                      | 5.1.6                      | H.264 μΈμ½”λ”© λ° μ¤νΈλ¦¬λ°             |
| μ„λ²„ κ°λ° (TCP)    | Raspberry Pi OS (Linux)     | Debian GNU/Linux 12       | μ°¨λ‰ μ†λ„ μ΄λ²¤νΈ μμ‹  μ„λ²„           |
| μΉ΄λ©”λΌ μ„λ²„        | Raspberry Pi OS (Linux)     | λ™μΌ                       | IMX500 μΉ΄λ©”λΌ μ—°λ™                    |
| μ»¤λ„               | Linux Kernel                | 6.1.21 aarch64             | λ””λ°”μ΄μ¤ μ μ–΄, λ„¤νΈμ›ν¬               |
| νμ›¨μ–΄ κ°λ°        | STM32CubeIDE                | 1.13.0                     | μ†λ„ κ°μ§€ μ„Όμ„ νμ›¨μ–΄ κ°λ°           |
| μ–Έμ–΄               | C/C++                       | g++ 10.2.1 (Raspberry Pi)  | μ „μ²΄ μ„λ²„ μ½”λ“                        |
| DB                 | SQLite                      | 3.40.1                     | μ΄λ²¤νΈ νμ¤ν† λ¦¬ μ €μ¥                  |
| λ³΄μ•               | OpenSSL                     | 3.0.16                     | TLS κΈ°λ° ν†µμ‹  μ•”νΈν™”                  |
| κ°μ²΄ κ°μ§€          | IMX500 λ‚΄λ¶€ .rpk λ¨λΈ       | Sony Neural Network        | μ°¨λ‰/μ‚¬λ κ°μ§€ (μ—£μ§€ μ¶”λ΅ )           |
| λ²νΈν νƒμ§€        | ONNX Runtime (C++)          | 1.16.0                     | μ°¨λ‰ λ²νΈν μ„μΉ κ°μ§€                 |
| λ²νΈν μΈμ‹        | TFLite (C++)                | 2.14.0                     | λ²νΈν λ¬Έμ OCR                       |

---

## π“‚ μ£Όμ” λ””λ ‰ν† λ¦¬ κµ¬μ΅°

```bash
IMX500-server/
β”β”€β”€ camera/                # start_camera.sh μ¤ν¬λ¦½νΈ
β”β”€β”€ cpp/
β”‚   β”β”€β”€ build/             # λΉλ“λ μ‹¤ν–‰ νμΌ
β”‚   β”β”€β”€ include/           # κ³µν†µ ν—¤λ” νμΌ
β”‚   β””β”€β”€ src/
β”‚       β”β”€β”€ detect/        # λ²νΈν/λ³΄ν–‰μ/μ†λ„ κ°μ§€
β”‚       β”β”€β”€ mqtt/          # MQTT μ „μ†΅
β”‚       β”β”€β”€ upload/        # μ¤λƒ…μƒ· μ „μ†΅ λ° DB λ“±λ΅
β”‚       β”β”€β”€ stream/        # RTSP μ†΅μ¶
β”‚       β”β”€β”€ control/       # LCD/μ¤ν”Όμ»¤ λ””λ°”μ΄μ¤ μ μ–΄
β”β”€β”€ run_all.sh             # μ „μ²΄ AI λ¨λ“ μ‹¤ν–‰
β”β”€β”€ start_camera.sh        # Picamera2 + IMX500 μ‹¤ν–‰
β””β”€β”€ runlogs/               # λ΅κ·Έ μ €μ¥ ν΄λ”
```

---

## β™οΈ Raspberry Pi IMX500 μ΄κΈ° μ„¤μ • κ°€μ΄λ“

IMX500 μΉ΄λ©”λΌλ¥Ό μ‚¬μ©ν•κΈ° μ„ν•΄, λΌμ¦λ² λ¦¬νμ΄μ μ‹μ¤ν…κ³Ό νμ›¨μ–΄λ¥Ό λ‹¤μ μμ„λ΅ μ¤€λΉ„ν•΄μ•Ό ν•©λ‹λ‹¤.

### 1. μ‹μ¤ν… μ—…λ°μ΄νΈ

```bash
sudo apt update && sudo apt full-upgrade
````

### 2. IMX500 μΉ΄λ©”λΌ νμ›¨μ–΄ μ„¤μΉ

```bash
sudo apt install imx500-all
```

### 3. νμ›¨μ–΄ λ²„μ „ ν™•μΈ

```bash
dmesg | grep 2040
```

* μ¶λ ¥ λ‚΄μ©μ— `fw ver.14`κ°€ ν¬ν•¨λμ–΄ μλ‹¤λ©΄ **μ—…λ°μ΄νΈκ°€ ν•„μ”**ν•©λ‹λ‹¤.

### 4. νμ›¨μ–΄ μ—…λ°μ΄νΈ (ν•„μ”ν• κ²½μ°)

1. μ•„λ κµ¬κΈ€ λ“λΌμ΄λΈμ—μ„ `imx500_i2c_flash` λ° `main_v15.bin` νμΌμ„ λ‹¤μ΄λ΅λ“ν•©λ‹λ‹¤:
   [νμ›¨μ–΄ λ‹¤μ΄λ΅λ“ λ§ν¬](https://drive.google.com/drive/folders/1aUWJt8y4i1wAmRtE28j1tbEOTYlS3gzJ)

2. μ•„λ λ…λ Ήμ–΄λ΅ κ¶ν• μ„¤μ • λ° μ—…λ°μ΄νΈλ¥Ό μ§„ν–‰ν•©λ‹λ‹¤:

```bash
chmod +x ./imx500_i2c_flash
./imx500_i2c_flash main_v15.bin
```

### 5. config.txt μ„¤μ • μ¶”κ°€

```bash
sudo nano /boot/firmware/config.txt
```

μ•„λ λ‚΄μ©μ„ νμΌ λ§¨ μ•„λμ— μ¶”κ°€ν•©λ‹λ‹¤:

```ini
[cm4]
otg_node=1

[cm5]
dtoverlay=dwc2,dr_mode=host

[all]
dtoverlay=imx500
```

### 6. λ¦¬λ¶€νΈ ν›„ λ²„μ „ ν™•μΈ

```bash
sudo reboot
dmesg | grep 2040
```
## π› οΈ κ°λ° ν™κ²½ κµ¬μ¶• (Raspberry Pi OS κΈ°μ¤€)
μ΄ ν”„λ΅μ νΈλ¥Ό μ‹¤ν–‰ν•κΈ° μ„ν•΄ μ•„λ ν¨ν‚¤μ§€λ¥Ό λ¨Όμ € μ„¤μΉν•΄ μ£Όμ„Έμ”:

```bash
sudo apt update
sudo apt install -y \
    build-essential \
    cmake \
    pkg-config \
    libssl-dev \
    libmosquitto-dev \
    mosquitto \
    libzmq3-dev \
    libczmq-dev \
    libnlohmann-json-dev \
    libopencv-dev \
    ffmpeg \
    v4l-utils \
    libavcodec-dev \
    libavformat-dev \
    libavutil-dev \
    libswscale-dev \
    libcurl4-openssl-dev \
    liblgpio-dev
```
## π“¦ ν¨ν‚¤μ§€ μ„¤λ…
| ν¨ν‚¤μ§€λ…                                     | μ„¤λ…                               |
| ---------------------------------------- | -------------------------------- |
| `build-essential`, `cmake`, `pkg-config` | C++ κ°λ° λ„κµ¬                        |
| `libssl-dev`                             | OpenSSL κΈ°λ° TLS ν†µμ‹                 |
| `libmosquitto-dev`, `mosquitto`          | MQTT λ©”μ‹μ§•                         |
| `libzmq3-dev`, `libczmq-dev`             | ZeroMQ λ©”μ‹μ§•                       |
| `libnlohmann-json-dev`                   | JSON νμ‹±                          |
| `libopencv-dev`                          | OpenCV μμƒμ²λ¦¬ (SHM ν”„λ μ„ λ””μ½”λ”©μ©)       |
| `ffmpeg`                                 | μ‹¤μ‹κ°„ μΈμ½”λ”© λ° RTSP μ†΅μ¶ (popen λ°©μ‹)     |
| `v4l-utils`                              | H.264 ν•λ“μ›¨μ–΄ μΈμ½”λ”© (`h264_v4l2m2m`)μ© |
| `libav*` μ‹λ¦¬μ¦                             | FFmpeg μ—°λ™μ„ μ„ν• λΌμ΄λΈλ¬λ¦¬ λ¨λ“           |
| `libcurl4-openssl-dev`                   | HTTP API νΈμ¶μ© libcurl             |
| `liblgpio-dev`                           | Raspberry Pi GPIO μ μ–΄μ© C λΌμ΄λΈλ¬λ¦¬    |


---

## π”§ μ‹μ¤ν… μ‹¤ν–‰ μμ„

### 0. λ””λ°”μ΄μ¤ λ“λΌμ΄λ²„ λ° ν•λ“μ›¨μ–΄ μƒνƒ ν™•μΈ

IMX500-server μ‹μ¤ν…μ΄ μ •μƒμ μΌλ΅ λ™μ‘ν•λ ¤λ©΄, λ‹¤μκ³Ό κ°™μ€ μ¥μΉ λ“λΌμ΄λ²„ λ° ν•λ“μ›¨μ–΄ μ—°κ²° μƒνƒλ¥Ό μ‚¬μ „μ— ν™•μΈν•΄μ•Ό ν•©λ‹λ‹¤.

#### 0.1 λΈ”λ£¨ν¬μ¤ μ—°κ²° ν™•μΈ

STM32μ™€ λΌμ¦λ² λ¦¬νμ΄ κ°„ λ°μ΄ν„° μ†΅μμ‹ μ„ μ„ν•΄ HC-05 λΈ”λ£¨ν¬μ¤ λ¨λ“μ΄ `/dev/rfcomm0` λ“±μΌλ΅ μΈμ‹λμ–΄ μμ–΄μ•Ό ν•©λ‹λ‹¤.

```bash
ls /dev/rfcomm*
```

μ¥μΉκ°€ μ—†λ‹¤λ©΄ μλ™μΌλ΅ λ°”μΈλ”©μ„ μν–‰ν•΄μ•Ό ν•©λ‹λ‹¤:

```bash
sudo rfcomm bind /dev/rfcomm0 <STM32_BLUETOOTH_MAC_ADDRESS>
```

#### 0.2 μ¤λ””μ¤ λ“λΌμ΄λ²„ (mydriver) λ“±λ΅

MAX98357Aμ© κ²½λ‰ν™”λ ALSA SoC λ“λΌμ΄λ²„κ°€ μ»¤λ„μ— λ“±λ΅λμ–΄μ•Ό ν•λ©°, `/boot/firmware/config.txt` νμΌμ— λ‹¤μ λ‚΄μ©μ„ μ¶”κ°€ν•©λ‹λ‹¤:

```ini
# /boot/firmware/config.txt μμ‹

dtoverlay=mydriver
```

μ„¤μ • ν›„ μ‹μ¤ν…μ„ μ¬λ¶€ν…ν•©λ‹λ‹¤:

```bash
sudo reboot
```

#### 0.3 μΊλ¦­ν„° λ””λ°”μ΄μ¤ λ“λΌμ΄λ²„ μλ™ λ“±λ΅

λ³΄ν–‰μ κ²½κ³  μ‹μ¤ν… λ™μ‘μ„ μ„ν•΄, λ‹¤μ μ„Έ κ°€μ§€ μ»¤λ„ λ¨λ“μ„ μλ™μΌλ΅ μ‚½μ…ν•΄μ•Ό ν•©λ‹λ‹¤:

```bash
cd ~/myproject/cpp/src/control/driver
sudo insmod alert_trigger.ko
sudo insmod lcd_notify.ko
sudo insmod wav_notify.ko
```

##### (1) Major λ²νΈ ν™•μΈ

`/proc/devices`λ¥Ό ν™•μΈν•μ—¬ κ° λ””λ°”μ΄μ¤ λ“λΌμ΄λ²„μ major λ²νΈλ¥Ό ν™•μΈν•©λ‹λ‹¤:

```bash
cat /proc/devices
```

μμ‹ μ¶λ ¥:

```
234 wav_notify
235 lcd_notify
236 alert_trigger
```

##### (2) /dev/ μ¥μΉ νμΌ μλ™ μƒμ„±

ν™•μΈλ major λ²νΈλ¥Ό κΈ°λ°μΌλ΅ λ‹¤μ λ…λ Ήμ–΄λ¥Ό ν†µν•΄ μΊλ¦­ν„° λ””λ°”μ΄μ¤ λ…Έλ“λ¥Ό μƒμ„±ν•©λ‹λ‹¤:

```bash
sudo mknod /dev/alert_trigger c 236 0
sudo mknod /dev/lcd_notify c 235 0
sudo mknod /dev/wav_notify c 234 0
sudo chmod 666 /dev/alert_trigger /dev/lcd_notify /dev/wav_notify
```

> μ°Έκ³ : Major λ²νΈλ” μ‹μ¤ν…λ§λ‹¤ λ‹¤λ¥Ό μ μμΌλ‹ `/proc/devices` μ¶λ ¥κ°’μ„ λ°λ“μ‹ ν™•μΈ ν›„ λ°μν•μ„Έμ”.

### 1. TCP μ΄λ²¤νΈ μ„λ²„ λΉλ“ λ° μ‹¤ν–‰ (`raspi-cctv-tcp-server`)
β†’ μ°¨λ‰ μ†λ„ λ° μ΄λ²¤νΈ μμ‹  μ„λ²„ κµ¬λ™

```bash
cd ~/myproject/raspi-cctv-tcp-server
mkdir build && cd build
cmake ..
make server
./server
````

---

### 2. IMX500 μ„λ²„ μ‹¤ν–‰ (`IMX500-server`)
β†’ μΉ΄λ©”λΌ κΈ°λ° AI κ°μ§€ λ° μ΄λ²¤νΈ μ†΅μ¶ μ²λ¦¬

```bash
cd ~/IMX500-server/camera
./start_camera.sh    # μΉ΄λ©”λΌ λ° κ³µμ λ©”λ¨λ¦¬ μ—°λ™ μ‹μ‘

cd ~/IMX500-server/cpp/build
./run_all.sh         # λ²νΈν κ°μ§€, OCR, μ΄λ²¤νΈ κ°μ§€ λ“± μ „μ²΄ λ¨λ“ μ‹¤ν–‰
```

---

### 3. QuadQT μ‹¤ν–‰ (MinGW ν™κ²½)
(https://github.com/VEDA-QuadZone/QuadQT/releases/tag/v1.0.0)
μ„ λ§ν¬ μ ‘μ† ν›„ λ°°ν¬νμΌ λ‹¤μ΄λ΅λ“ ν›„ μ‹¤ν–‰νμΌμ„ μ‹¤ν–‰ν•μ„Έμ”
---

## π§  λ‚΄λ¶€ μ²λ¦¬ κµ¬μ΅° (IMX500-server)

### [`start_camera.sh`]
- Picamera2 + IMX500 μ—°λ™
- μ‹¤μ‹κ°„ ν”„λ μ„ β†’ κ³µμ  λ©”λ¨λ¦¬ κΈ°λ΅
- `.rpk` κ²°κ³Ό (ObjectDetectResult) λ©”νƒ€λ°μ΄ν„° κΈ°λ΅

### [`run_all.sh`]
- λ²νΈν νƒμ§€ (ONNX)
- λ²νΈν OCR (TFLite)
- λ¶λ²•μ£Όμ •μ°¨, κ³Όμ†, λ³΄ν–‰μ κ°μ§€
- RTSP μ†΅μ¶ (FFmpeg)
- μ΄λ²¤νΈ MQTT λ°ν–‰
- μ¤λƒ…μƒ· λ° λ©”νƒ€λ°μ΄ν„° κΈ°λ΅ (`/dev/shm`)

---

## π”— μ°Έκ³  λ ν¬μ§€ν† λ¦¬

- **λ²νΈν OCR λ¨λΈ**: [KR_LPR_Jax (by noahzhy)](https://github.com/noahzhy/KR_LPR_Jax)  
  β””β”€ ν•κµ­ λ²νΈν μΈμ‹μ— νΉν™”λ CTC κΈ°λ° TFLite OCR λ¨λΈ
